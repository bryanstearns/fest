# Place all the behaviors and hooks related to the matching controller here.
# All this logic will automatically be available in application.js.
# You can use CoffeeScript in this file: http://jashkenas.github.com/coffee-script/
<% environment.context_class.instance_eval { include PicksHelper } %>

jQuery ->
  logged_in = -> jQuery("#sign_out").length == 1

  # Set up the Raty plugin to manage priorities and ratings

  not_signed_in = ->
    alert("You're not signed in; you can sign in to prioritize your " +
          "films, or click the Sign Up link in the upper right corner " +
          "to get started.")

  film_id_for = (div) ->
    jQuery(div).attr('id').split('_')[1]

  save_pick = (div, attribute, value) ->
    if logged_in()
      film_id = film_id_for(div)
      pick_form = jQuery('#new_pick')
      pick_form.attr('action',
        pick_form.attr('action').replace(/\d+/, film_id))
      pick_form.find('input[name="attribute"]').val(attribute)
      pick_form.find('input[name="pick[' + attribute + ']"]').val(value)
      progress = jQuery("#" + "film_" + film_id + "_progress")
      progress.show()
      pick_form.ajaxSubmit(
        dataType: 'script'
        success: ->
          progress.hide()
        error: (context, xhr, e, status) ->
          progress.hide()
          window.location = "/500.html"
      )
      true
    else
      not_signed_in()

  # Set up priority dots
  priority_to_index = <%= pick_priority_to_index_in_javascript %>
  index_to_priority = <%= pick_index_to_priority_in_javascript %>
  priority_divs = jQuery('.dots')
  priority_divs.each (index, div) ->
    pick = PICKS_BY_FILM_ID[film_id_for(div)]
    if pick and pick.priority
      jQuery(div).attr('data-priority', pick.priority)
  priority_divs.raty(
    cancel: true
    cancelHint: 'Forget this priority'
    hints: <%= pick_priority_hints_in_javascript %>
    path: '<%= File.dirname(image_path('raty/face-a.png')) %>'
    size: 18
    iconRange: [
      { range: 1, on: 'face-a.png', off: 'face-a-off.png' }
      { range: 5, on: 'face-b.png', off: 'face-b-off.png' }
    ]
    score: ->
      priority_to_index[$(this).attr('data-priority')]
    click: (score, evt) ->
      save_pick(this, 'priority', index_to_priority[score])
  )

  # Set up rating stars
  rating_divs = jQuery('.stars')
  rating_divs.each (index, div) ->
    pick = PICKS_BY_FILM_ID[film_id_for(div)]
    if pick and pick.rating
      jQuery(div).attr('data-rating', pick.rating)
  rating_divs.raty(
    cancel: true
    cancelHint: 'Forget this rating'
    number: 5,
    hints: <%= pick_rating_hints_in_javascript %>
    path: '<%= File.dirname(image_path('raty/face-a.png')) %>'
    size: 18
    score: ->
      $(this).attr('data-rating')
    click: (score, evt) ->
      save_pick(this, 'rating', score)
  )
